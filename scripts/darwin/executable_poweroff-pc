#!/bin/bash

# Required parameters:
# @raycast.schemaVersion 1
# @raycast.title turn pc off
# @raycast.mode compact

# Documentation:
# @raycast.author joshika39
# @raycast.authorURL https://raycast.com/joshika39

usage() {
	echo "Usage: $0 [-h host]"
	echo "  -h host   SSH host (env POWEROFF_HOST)"
	exit 64
}

set -Eeuo pipefail

if [[ -f .env ]]; then
	set -a
	source .env
	set +a
fi

HOST="${POWEROFF_HOST:-}"
SSH_OPTS=${SSH_OPTS:-"-o IdentitiesOnly=yes -o ConnectTimeout=20 -o StrictHostKeyChecking=accept-new"}
POWEROFF_PATH=${POWEROFF_PATH:-poweroff}

# Check for a -h argument and store it in the HOST

while getopts ":h:" opt; do
	case "$opt" in
	h) HOST="$OPTARG" ;;
	*) usage ;;
	esac
done

if [[ -z "$HOST" ]]; then
	echo "Error: missing host. Set POWEROFF_HOST or use -h <HOST>." >&2
	usage
fi

ssh -t $SSH_OPTS "$HOST" "sudo -n $POWEROFF_PATH || $POWEROFF_PATH"
